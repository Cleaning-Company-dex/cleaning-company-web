name: Deploy Flask to PythonAnywhere

on:
  push:
    branches:
      - main

env:
  PA_USERNAME: yerielcruz18
  PA_DOMAIN: yerielcruz18.pythonanywhere.com

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Deploy to PythonAnywhere via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ssh.pythonanywhere.com
          username: yerielcruz18
          password: ${{ secrets.PYTHONANYWHERE_SSH_PASSWORD }}
          port: 22
          script: |
            echo "ğŸš€ Iniciando deployment de Flask app..."

            # Navegar al directorio del proyecto
            cd ~/Cleaning_Services || { echo "âŒ Directorio no encontrado"; exit 1; }

            # Mostrar informaciÃ³n actual
            echo "ğŸ“ Branch actual: $(git branch --show-current)"
            echo "ğŸ“ Ãšltimo commit local: $(git log -1 --oneline)"

            # Guardar cambios locales si existen
            git stash

            # Obtener los Ãºltimos cambios
            echo "ğŸ“¥ Descargando cambios desde GitHub..."
            git fetch origin main
            git reset --hard origin/main

            # Verificar que el pull funcionÃ³
            echo "âœ“ Ãšltimo commit despuÃ©s del pull: $(git log -1 --oneline)"

            # Instalar/actualizar dependencias
            echo "ğŸ“¦ Instalando dependencias de Python..."
            pip3.8 install -r requirements.txt --user

            # Verificar que el archivo .env existe
            if [ -f ".env" ]; then
              echo "âœ“ Archivo .env encontrado"
            else
              echo "âš ï¸ Archivo .env no encontrado"
              echo "   AsegÃºrate de configurar las variables de entorno en PythonAnywhere"
            fi

            # Verificar que app.py existe
            if [ -f "app.py" ]; then
              echo "âœ“ Archivo app.py encontrado"
            else
              echo "âŒ Error: app.py no encontrado"
              exit 1
            fi

            # Recargar la aplicaciÃ³n web tocando el archivo WSGI
            echo "â™»ï¸ Recargando aplicaciÃ³n Flask..."
            touch /var/www/yerielcruz18_pythonanywhere_com_wsgi.py

            echo "âœ… Deployment de Flask completado!"
            echo "ğŸ“… Fecha: $(date)"

      - name: Wait for reload
        run: |
          echo "â³ Esperando 30 segundos para que la aplicaciÃ³n se recargue..."
          sleep 30

      - name: Verify deployment
        run: |
          echo "ğŸ” Verificando deployment..."

          max_attempts=3
          attempt=1

          while [ $attempt -le $max_attempts ]; do
            echo "Intento $attempt de $max_attempts..."
            
            # Hacer peticiÃ³n con timeout y user agent
            response=$(curl -s -o /dev/null -w "%{http_code}" \
              --max-time 10 \
              -H "User-Agent: GitHub-Actions-Deploy-Check" \
              https://${{ env.PA_DOMAIN }} || echo "000")
            
            if [ "$response" = "200" ]; then
              echo "âœ… Sitio funcionando correctamente (HTTP $response)"
              echo "ğŸ”— URL: https://${{ env.PA_DOMAIN }}"
              exit 0
            elif [ "$response" = "000" ]; then
              echo "âš ï¸ Timeout o error de conexiÃ³n"
            else
              echo "âš ï¸ Sitio devolviÃ³ HTTP $response"
            fi
            
            if [ $attempt -lt $max_attempts ]; then
              echo "Esperando 15 segundos antes del siguiente intento..."
              sleep 15
            fi
            
            attempt=$((attempt + 1))
          done

          echo "â„¹ï¸ La verificaciÃ³n no pudo confirmar HTTP 200"
          echo "   Esto es normal si PythonAnywhere estÃ¡ tardando en recargar."
          echo "   Por favor, verifica manualmente: https://${{ env.PA_DOMAIN }}"

          # No fallar el workflow, ya que el deploy pudo ser exitoso
          exit 0

      - name: Deployment summary
        if: always()
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“Š RESUMEN DEL DEPLOYMENT"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“¦ Repositorio: ${{ github.repository }}"
          echo "ğŸŒ¿ Branch: ${{ github.ref_name }}"
          echo "ğŸ”§ Commit: ${{ github.sha }}"
          echo "ğŸ‘¤ Iniciado por: ${{ github.actor }}"
          echo "ğŸ–¥ï¸ Usuario PA: ${{ env.PA_USERNAME }}"
          echo "ğŸŒ Dominio: https://${{ env.PA_DOMAIN }}"
          echo "ğŸ“… Fecha: $(date)"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… DEPLOYMENT EXITOSO"
          else
            echo "âš ï¸ Revisa los logs para mÃ¡s detalles"
          fi
